---
title: Infrastructure
description: Where the bits go, to and fro
---

# Infrastructure

## Introduction

The purpose of these documents are to provide an overview of the infrastructure used to operate the Mastodon instance and ancillary services that make up [vmst.io](https://vmst.io).
It should explain how the various services interact and how "the magic" happens when our users open the Mastodon app on their phone or enter our address into their web browser.

::alert{type="warning"}
Unfortunately, it's not really magic, but rather a series of databases and services from various open-source vendors running in a number of different best-in-class public cloud providers.
::

## Architecture Goals

::list{type="success"}
- Be highly available for all critical components.
- Be scalable both vertically and horizontally.
- Provide a highly performant experience for our users.
- Maintain a stable endpoint on the [ActivityPub](https://activitypub.rocks) network.
::

## Layout

![Server Layout](/vmstio-simple.png)

## Core Services

Our core service is the Mastodon platform located at [vmst.io](https://vmst.io).

[Digital Ocean](https://www.digitalocean.com) is our primary hosting provider for this service.
Our primary data centers are TOR1 and NYC3, with Toronto holding the bulk of the computing workloads and New York for the object storage.

### Required Components

The following reflect the required software components to have a functional deployment of Mastodon:

- [Mastodon](https://github.com/mastodon/mastodon) (obviously)
- [PostgreSQL](https://www.postgresql.org/)
- [Redis](https://redis.io/)
- [Nginx](https://nginx.org/) (or another reverse proxy)

### Additional Components

Most Mastodon deployments leverage one or more additional components to provide additional functionality.

Some of them include:

- Elastic Search
- Translation API
- [Object Storage](https://en.wikipedia.org/wiki/Object_storage)
- [SMTP Relay](https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol)

## Core Elements

### Virtual Machines

We use an all virtual architecture using Digital Ocean "Droplets" as Kubernetes nodes.
These Droplets are provisioned automatically by the Kubernetes control plane.
There are typically three nodes with 4 vCPU and 8 GB of memory each.

### Kubernetes

We use the Digital Ocean managed Kubernetes service.

### Load Balancing

We use Digital Ocean managed load balancer objects to distribute user traffic across our frontend reverse proxies.

### Reverse Proxies

We use [Nginx](https://www.nginx.com) as our reverse proxy software.
In our Kubernetes environment this is in the form of the [Nginx Ingress Controller](https://kubernetes.github.io/ingress-nginx/).

Our Nginx reverse proxies provide TLS/SSL termination.

![Reverse Proxy Diagram](/reverse-proxy.png)

## Mastodon Elements

Aside from the various external dependencies, Mastodon is three main applications:

- Web UI & API
- Streaming API
- Sidekiq

### Web

The Mastodon Web tier consists of the Mastodon Web UI/API and the separate Streaming API service.
Our Web tier runs on the Digital Ocean managed Kubernetes platform.

#### Puma

What users perceive as "Mastodon" is a [Ruby on Rails](https://rubyonrails.org) and [React](https://react.dev) application (with [Puma](https://puma.io) running as the web/presentation layer) providing both ActivityPub/Federation and the web user experience.
We use Ruby 3.2 and the other modules that are part of the standard [Dockerfile](https://github.com/mastodon/mastodon/blob/main/Dockerfile) build of Mastodon.

Based on recommendations by the developer of Puma, and others in the Mastodon administration community, we have Puma configured in `.env.production` and as follows:

```text
WEB_CONCURRENCY=3
MAX_THREADS=9
```

This follows a ratio of `vCPU * 1.5` for concurrency.
The number of threads is then `concurrency * 3`.

Additionally, in the default configuration where Nginx and Mastodon Puma would run on the same node, there are static files (CSS and image) that make up the user interface that are served directly by Nginx.
Because we separate Nginx into its own tier on different machines, there is a setting to tell the Mastodon web server to serve these files instead.

```text
RAILS_SERVE_STATIC_FILES=true
```

According to [the Mastodon documentation](https://docs.joinmastodon.org/admin/config/#rails_serve_static_files) this does increase load on the Mastodon server, but in our experience it's not been a measurable difference.

#### Streaming

The Streaming API is a separate [node.js](https://nodejs.org/en/) application which provides a background WebSockets connection between your browser session and the Mastodon server to provide real-time "streaming" updates as new posts are loaded to your timeline, to send notifications, etc.

As explained more in-depth in another section, the connection to the Digital Ocean-managed Redis database must be done via TLS.
For the Streaming API, there are additional configuration options that must be set to allow node.js to connect when it expects a non-encrypted connection by default.

Example of `.env.production` configuration settings relevant to Streaming:

```text
# Streaming
STREAMING_API_BASE_URL=wss://streaming.vmst.io
DB_SSLMODE=require
NODE_EXTRA_CA_CERTS=/path/to/certs/do-internal.crt
```

The `DB_SSLMODE` and `NODE_EXTRA_CA_CERTS` settings are not there by default.
The Digital Ocean databases use self-signed/private certificates, but the variable set will tell the Streaming API to trust that connection based on the CA certs that are downloaded from Digital Ocean and uploaded to the server.



## Flings

Outside of our core service we run a number of "Flings" such as:

- [elk.vmst.io](https://elk.vmst.io)
- [matrix.vmst.io](https://matrix.vmst.io)
- [element.vmst.io](https://element.vmst.io)

### Matrix

Our Matrix deployment is based on [Synapse](https://matrix.org/docs/projects/server/synapse) server, running in a Docker container from the project's official [Docker Hub image](https://hub.docker.com/r/matrixdotorg/synapse).

Our implementation is configured to authenticate against [vmst.io](https://vmst.io), so your Mastodon username and password is a single sign-on to this service.

Example of the Synapse `homeserver.yaml` relevant to authentication:

```text
oidc_providers:
- idp_id: my_mastodon
  idp_name: "Mastodon"
  discover: false
  issuer: "https://vmst.io/@whodoyouthink"
  client_id: "theitsybitsyspiderwentupthewaterspout"  
  client_secret: "downcametherainandwashedthespiderout"
  authorization_endpoint: "https://vmst.io/oauth/authorize"
  token_endpoint: "https://vmst.io/oauth/token"
  userinfo_endpoint: "https://vmst.io/api/v1/accounts/verify_credentials"
  scopes: ["read"]
  user_mapping_provider:
    config:
      subject_claim: "id"

password_config:
    enabled: false
```

_Out came the sun and dried up all the..._ sorry.

#### Element Web

We run our own instance of Element Web from a Docker container.
When visiting [matrix.vmst.io](https://element.vmst.io) or [element.vmst.io](https://element.vmst.io) users are automatically directed there, configured to use our Matrix homeserver.

Once their account is established, users are encouraged to use a dedicated Matrix client from their desktop or mobile device.

Element Web runs on a the [Netlify](https://www.netlify.com) managed platform.

### Elk

Elk is an [open source project](https://github.com/elk-zone/elk) to build an alternative web frontend for Mastodon.
It’s in very active development, but is considered “alpha” by their team.

As Elk is very popular among our most active users, and we are also listed on the official project page as an alternative host to their own instance, we seek to run the latest released version Elk components from their upstream projects.

For more information please refer to our original [Elk](/post/2023/01/elk/) announcement.

Elk runs on a the [Netlify](https://www.netlify.com) managed platform.

### Other Sources

Similar to our policy on our core services, we seek to run the latest released version of our Fling components from their upstream projects.
However in some cases we are contributing to the development of these projects, and from time to time may run modified versions to assist with this task.

Our activity level may vary from Fling to Fling with our contributions to the upstream project.

## Documentation

Our documentation website [docs.vmst.io](https://docs.vmst.io) runs on the [Netlify](https://www.netlify.com) app platform.
It is a [Hugo](https://gohugo.io) static website using [a custom version](https://github.com/vmstan/hugo-PaperModXRand) of the the [PaperModX](https://github.com/reorx/hugo-PaperModX) theme called "Rand".
It's automatically generated anytime there is a push event to the [underlying Git repository](https://github.com/vmstan/vmstio).
It uses an integrated CDN provided by Netlify.

If you would like to edit or contribute to the documentation on this site, you may fork the site and submit pull requests to our staging branch.

Please review our [contribution guide](https://github.com/vmstan/vmstio/docs.vmst.io/README.md) for more information.

## Command and Control

### Automation

We use the open source [n8n](https://n8n.io/) platform to perform automation tasks and send notifications.
n8n is similar to Zapier, IFTTT, or Power Automate, but can be self-hosted.

n8n connects various APIs from Mastodon, Slack, Matrix, Patreon, Ko-fi, Google, and GitHub.

### People

There is a limited set of people with administrative controls to our core applications and infrastructure.
In the event of a disaster which limits those people from performing their duties, alternatives have been identified to take control of our system and insure continuity of operations.

## Naming Conventions

Our servers are named after characters and actors from the original Star Trek series, and other 23rd century derivatives.

Live long and prosper.
